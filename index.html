<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>2048 Custom</title>

<style>
body{
  margin:0;
  background:#faf8ef;
  font-family:sans-serif;
  touch-action:none;
}

h1{text-align:center;margin:10px 0}

#top{
  display:flex;
  justify-content:space-around;
  font-size:18px;
}

#board{
  width:300px;
  margin:15px auto;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
  background:#bbada0;
  padding:6px;
  border-radius:8px;
}

.cell{
  width:70px;
  height:70px;
  background:#cdc1b4;
  border-radius:6px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:22px;
  transition:transform .12s ease-in-out;
}

/* spawn & merge */
@keyframes spawn{0%{transform:scale(0.6)}100%{transform:scale(1)}}
@keyframes glow{
  0%{box-shadow:none}
  50%{box-shadow:0 0 12px white}
  100%{box-shadow:none}
}
.spawn{animation:spawn .15s ease-out,glow .3s ease-out}

@keyframes merge{
  0%{transform:scale(1)}
  50%{transform:scale(1.25)}
  100%{transform:scale(1)}
}
.merge{animation:merge .18s ease-out}

/* tile colors */
.n2{background:#eee4da}
.n4{background:#f0d9c2}
.n8{background:#f2b179}
.n16{background:#f59563}
.n32{background:#f67c5f}
.n64{background:#f65e3b;color:#fff}
.n128,.n256,.n512,.n1024,.n2048{background:#edcf72}
.n4096{background:#000;color:#fff}
.n8192{background:purple;color:#fff}
.n16384{background:pink}
.n32768{background:#fff}

/* buttons */
#controls{text-align:center}
button{margin:4px;padding:6px 10px;font-size:14px}

.locked{background:#aaa;color:#555}

#gameover{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  color:white;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:22px;
}
</style>
</head>

<body>
<h1>2048</h1>

<div id="top">
  <div>Score: <span id="score">0</span></div>
  <div>Best: <span id="best">0</span></div>
</div>

<div id="board"></div>

<div id="controls">
  <button onclick="move('U')">↑</button><br>
  <button onclick="move('L')">←</button>
  <button onclick="move('D')">↓</button>
  <button onclick="move('R')">→</button><br><br>

  <button onclick="fullReset()">RESET</button><br><br>

  <button id="r2048" onclick="specialReset(2048,20000)">2048</button>
  <button id="r4096" onclick="specialReset(4096,40000)">4096</button>
  <button id="r8192" onclick="specialReset(8192,80000)">8192</button>
  <button onclick="info()">i</button>
</div>

<div id="gameover">
  <div>GAME OVER</div>
  <div id="finalScore"></div>
  <div id="newRecord"></div>
  <button onclick="fullReset()">Restart</button>
</div>

<script>
const SIZE=4;
let board,score=0,spawned=null,mergedPos=[];
let best=Number(localStorage.getItem("best"))||0;
document.getElementById("best").textContent=best;

function init(){
  mergedPos=[];
  spawned=null;
  document.getElementById("gameover").style.display="none";

  if(!loadGame()){
    board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
    score=0;
    spawn();spawn();
  }
  update();draw();
}

function spawn(){
  let e=[];
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++)
    if(!board[i][j]) e.push([i,j]);
  if(!e.length) return;
  const [r,c]=e[Math.random()*e.length|0];
  board[r][c]=Math.random()<0.9?2:4;
  spawned=[r,c];
}

function slide(row,r,dir){
  let res=[],skip=false;
  for(let i=0;i<row.length;i++){
    if(skip){skip=false;continue}
    if(row[i]&&row[i]===row[i+1]){
      let v=row[i]*2;score+=v;
      let c=res.length;
      if(dir==="R"||dir==="D")c=SIZE-1-c;
      mergedPos.push(dir==="L"||dir==="R"?[r,c]:[c,r]);
      res.push(v);skip=true;
    }else res.push(row[i]);
  }
  while(res.length<SIZE)res.push(0);
  return res;
}

function move(dir){
  mergedPos=[];
  let moved=false;
  for(let i=0;i<SIZE;i++){
    let row=
      dir==="L"?board[i]:
      dir==="R"?[...board[i]].reverse():
      dir==="U"?board.map(v=>v[i]):
                board.map(v=>v[i]).reverse();

    let s=slide(row,i,dir);
    let f=(dir==="R"||dir==="D")?[...s].reverse():s;

    for(let j=0;j<SIZE;j++){
      let v=(dir==="L"||dir==="R")?board[i][j]:board[j][i];
      if(v!==f[j]) moved=true;
      if(dir==="L"||dir==="R") board[i][j]=f[j];
      else board[j][i]=f[j];
    }
  }

  if(moved){
    spawn();update();draw();saveGame();
    if(!canMove()) endGame();
  }
}

function canMove(){
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    if(!board[i][j]) return true;
    if(board[i][j]===board[i]?.[j+1]) return true;
    if(board[i][j]===board[i+1]?.[j]) return true;
  }
  return false;
}

function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    const v=board[i][j];
    const d=document.createElement("div");
    d.className="cell"+(v?" n"+v:"");
    if(v)d.textContent=v;
    if(spawned&&spawned[0]===i&&spawned[1]===j)d.classList.add("spawn");
    if(mergedPos.some(p=>p[0]===i&&p[1]===j))d.classList.add("merge");
    b.appendChild(d);
  }
  spawned=null;
}

function update(){
  document.getElementById("score").textContent=score;
  if(score>best){
    best=score;
    localStorage.setItem("best",best);
    document.getElementById("best").textContent=best;
  }
}

function endGame(){
  localStorage.removeItem("board");
  localStorage.removeItem("score");
  document.getElementById("finalScore").textContent="Score: "+score;
  document.getElementById("newRecord").textContent=score===best?"New Record!":"";
  document.getElementById("gameover").style.display="flex";
}

function saveGame(){
  localStorage.setItem("board",JSON.stringify(board));
  localStorage.setItem("score",score);
}

function loadGame(){
  let b=localStorage.getItem("board");
  let s=localStorage.getItem("score");
  if(b&&s){
    board=JSON.parse(b);
    score=Number(s);
    return true;
  }
  return false;
}

function fullReset(){
  localStorage.removeItem("board");
  localStorage.removeItem("score");
  init();
}

function specialReset(val,sc){
  score=sc;
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  board[0][0]=val;
  update();draw();saveGame();
}

function info(){
  alert("最高スコアが一定値に到達すると、2048 / 4096 / 8192 がある状態からゲームを開始できます");
}

init();
</script>
</body>
</html>
