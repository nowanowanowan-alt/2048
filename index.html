<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>2048</title>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:#faf8ef;
  overscroll-behavior:none;
  touch-action:none;
}
#game{
  width:320px;
  margin:20px auto;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.scorebox{
  background:#bbada0;
  color:white;
  padding:5px 10px;
  border-radius:6px;
  font-size:14px;
}
#board{
  margin-top:10px;
  background:#bbada0;
  padding:10px;
  border-radius:8px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
}
.cell{
  width:70px;
  height:70px;
  background:#cdc1b4;
  border-radius:6px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:22px;
  font-weight:bold;
}
.spawn{ animation:spawn .15s ease-out; }
.merge{ animation:merge .18s ease-out; }

@keyframes spawn{ from{transform:scale(0)} to{transform:scale(1)} }
@keyframes merge{
  0%{transform:scale(1)}
  50%{transform:scale(1.25)}
  100%{transform:scale(1)}
}

/* タイル色 */
.n2{background:#fff}
.n4{background:#f5e0c3}
.n8{background:#f2b179;color:#fff}
.n16{background:#f59563;color:#fff}
.n32{background:#f67c5f;color:#fff}
.n64{background:#f65e3b;color:#fff}
.n128,.n256,.n512,.n1024,.n2048{background:#edcf72}
.n4096{background:#000;color:#fff}
.n8192{background:purple;color:#fff}
.n16384{background:pink}
.n32768{background:#fff}

/* リセットボタン */
.reset-area{
  display:flex;
  gap:6px;
  margin-top:10px;
  justify-content:center;
}
.reset-area button{
  padding:6px;
  font-size:12px;
  border:none;
  border-radius:6px;
}
.locked{ background:#aaa;color:#555 }

/* i ボタン */
.info{
  width:32px;
  height:32px;
  border-radius:50%;
  font-weight:bold;
}

/* オーバーレイ共通 */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
.box{
  background:white;
  padding:20px;
  border-radius:8px;
  text-align:center;
}
.new{ color:red;font-weight:bold }
</style>
</head>

<body>
<div id="game">
  <div class="header">
    <div class="scorebox">Score<br><span id="score">0</span></div>
    <div class="scorebox">Best<br><span id="best">0</span></div>
  </div>

  <div id="board"></div>

  <div class="reset-area">
    <button id="r2048"></button>
    <button id="r4096"></button>
    <button id="r8192"></button>
    <button class="info" onclick="openInfo()">i</button>
  </div>
</div>

<div id="gameover" class="overlay">
  <div class="box">
    <h2>GAME OVER</h2>
    <p>Final Score: <span id="finalScore"></span></p>
    <p>Best Score: <span id="finalBest"></span></p>
    <p id="newRecord" class="new" style="display:none;">NEW RECORD!</p>
    <button onclick="init()">Restart</button>
  </div>
</div>

<div id="info" class="overlay" onclick="this.style.display='none'">
  <div class="box">
    最高スコアが一定値に到達すると<br>
    2048 / 4096 / 8192 がある状態から<br>
    ゲームを開始できます
  </div>
</div>

<script>
const SIZE=4;
let board,merged,score=0;
let best=Number(localStorage.getItem("best")||0);
let recordBroken=false;

const unlock={2048:25000,4096:50000,8192:100000};

function init(){
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  merged=[...Array(SIZE)].map(()=>Array(SIZE).fill(false));
  score=0;
  recordBroken=false;
  document.getElementById("gameover").style.display="none";
  spawn(); spawn();
  update(); draw();
}

function spawn(){
  let empty=[];
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++)
    if(!board[i][j]) empty.push([i,j]);
  if(!empty.length) return;
  const [r,c]=empty[Math.random()*empty.length|0];
  board[r][c]=Math.random()<0.9?2:4;
}

function slide(row,r){
  row=row.filter(v=>v);
  for(let i=0;i<row.length-1;i++){
    if(row[i]===row[i+1]){
      row[i]*=2; score+=row[i];
      row[i+1]=0; merged[r][i]=true;
    }
  }
  row=row.filter(v=>v);
  while(row.length<SIZE) row.push(0);
  return row;
}

function move(dir){
  merged=[...Array(SIZE)].map(()=>Array(SIZE).fill(false));
  let moved=false;
  for(let i=0;i<SIZE;i++){
    let r=dir==="L"?board[i]:
          dir==="R"?[...board[i]].reverse():
          dir==="U"?board.map(v=>v[i]):
                     board.map(v=>v[i]).reverse();
    let s=slide(r,i);
    let f=dir==="R"||dir==="D"?s.reverse():s;
    for(let j=0;j<SIZE;j++){
      let v=dir==="L"||dir==="R"?board[i][j]:board[j][i];
      let nv=f[j];
      if(v!==nv) moved=true;
      if(dir==="L"||dir==="R") board[i][j]=nv;
      else board[j][i]=nv;
    }
  }
  if(moved){
    spawn(); update(); draw();
    if(!canMove()) endGame();
  }
}

function canMove(){
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    if(!board[i][j]) return true;
    if(j<SIZE-1 && board[i][j]===board[i][j+1]) return true;
    if(i<SIZE-1 && board[i][j]===board[i+1][j]) return true;
  }
  return false;
}

function endGame(){
  document.getElementById("finalScore").textContent=score;
  document.getElementById("finalBest").textContent=best;
  if(recordBroken) document.getElementById("newRecord").style.display="block";
  document.getElementById("gameover").style.display="flex";
}

function update(){
  if(score>best){
    best=score;
    recordBroken=true;
    localStorage.setItem("best",best);
  }
  document.getElementById("score").textContent=score;
  document.getElementById("best").textContent=best;
  updateResetButtons();
}

function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    const v=board[i][j];
    const d=document.createElement("div");
    d.className="cell"+(v?" n"+v:"");
    if(v) d.textContent=v;
    if(merged[i][j]) d.classList.add("merge");
    b.appendChild(d);
  }
}

function updateResetButtons(){
  [2048,4096,8192].forEach(v=>{
    const b=document.getElementById("r"+v);
    if(best>=unlock[v]){
      b.textContent=v;
      b.className="n"+v;
      b.onclick=()=>specialReset(v);
    }else{
      b.textContent=`${unlock[v]}到達で解放`;
      b.className="locked";
      b.onclick=()=>alert(`スコア${unlock[v]}到達で解放`);
    }
  });
}

function specialReset(v){
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  board[1][0]=v;
  draw();
}

function openInfo(){
  document.getElementById("info").style.display="flex";
}

init();
</script>
</body>
</html>
