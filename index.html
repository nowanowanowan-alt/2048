<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2048 Custom</title>

<style>
*{
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
}

body{
  margin:0;
  background:#faf8ef;
  font-family:sans-serif;
  text-align:center;
}

h1{margin:10px 0}

#top{
  display:flex;
  justify-content:space-around;
  font-size:18px;
}

#board{
  width:300px;
  margin:15px auto;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
  background:#bbada0;
  padding:6px;
  border-radius:8px;
}

.cell{
  width:70px;
  height:70px;
  background:#cdc1b4;
  border-radius:6px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:22px;
  transition:transform .12s ease;
}

@keyframes spawn{0%{transform:scale(.6)}100%{transform:scale(1)}}
@keyframes merge{0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)}}

.spawn{animation:spawn .15s ease}
.merge{animation:merge .18s ease}

.n2{background:#eee4da}
.n4{background:#f0d9c2}
.n8{background:#f2b179}
.n16{background:#f59563}
.n32{background:#f67c5f}
.n64{background:#f65e3b;color:#fff}
.n128,.n256,.n512,.n1024,.n2048{background:#edcf72}
.n4096{background:#000;color:#fff}
.n8192{background:purple;color:#fff}
.n16384{background:pink}
.n32768{background:#fff}

button{
  margin:4px;
  padding:6px 10px;
  font-size:14px;
}

.locked{
  background:#aaa;
  color:#555;
}

#gameover{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  color:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:22px;
}
</style>
</head>

<body>
<h1>2048</h1>

<div id="top">
  <div>Score: <span id="score">0</span></div>
  <div>Best: <span id="best">0</span></div>
</div>

<div id="board"></div>

<div>
  <button onclick="move('U')">↑</button><br>
  <button onclick="move('L')">←</button>
  <button onclick="move('D')">↓</button>
  <button onclick="move('R')">→</button><br><br>

  <button onclick="fullReset()">RESET</button><br><br>

  <button id="r2048" onclick="specialReset(2048,20000,1)">2048</button>
  <button id="r4096" onclick="specialReset(4096,40000,2)">4096</button>
  <button id="r8192" onclick="specialReset(8192,80000,3)">8192</button>
  <button onclick="info()">i</button>
</div>

<div id="gameover">
  <div>GAME OVER</div>
  <div id="finalScore"></div>
  <div id="newRecord"></div>
  <button onclick="fullReset()">Restart</button>
</div>

<script>
const SIZE=4;
let board=[],score=0;
let best=Number(localStorage.getItem("best"))||0;
document.getElementById("best").textContent=best;

function init(){
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  score=0;
  spawn();spawn();
  update();draw();
}

function spawn(){
  let e=[];
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++)
    if(!board[i][j]) e.push([i,j]);
  if(!e.length) return;
  let [r,c]=e[Math.random()*e.length|0];
  board[r][c]=Math.random()<0.9?2:4;
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]===arr[i+1]){
      arr[i]*=2;
      score+=arr[i];
      arr.splice(i+1,1);
    }
  }
  while(arr.length<SIZE) arr.push(0);
  return arr;
}

function move(dir){
  let moved=false;
  for(let i=0;i<SIZE;i++){
    let row;
    if(dir==="L") row=slide(board[i]);
    if(dir==="R") row=slide([...board[i]].reverse()).reverse();
    if(dir==="U"){
      let col=slide(board.map(r=>r[i]));
      for(let j=0;j<SIZE;j++) if(board[j][i]!==col[j]) moved=true,board[j][i]=col[j];
      continue;
    }
    if(dir==="D"){
      let col=slide(board.map(r=>r[i]).reverse()).reverse();
      for(let j=0;j<SIZE;j++) if(board[j][i]!==col[j]) moved=true,board[j][i]=col[j];
      continue;
    }
    if(board[i].join()!=row.join()) moved=true;
    board[i]=row;
  }
  if(moved){
    spawn();
    update();
    draw();
    if(!canMove()) endGame();
  }
}

function canMove(){
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    if(!board[i][j]) return true;
    if(board[i][j]===board[i]?.[j+1]) return true;
    if(board[i][j]===board[i+1]?.[j]) return true;
  }
  return false;
}

function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let r of board)for(let v of r){
    let d=document.createElement("div");
    d.className="cell"+(v?" n"+v:"");
    d.textContent=v||"";
    b.appendChild(d);
  }
}

function update(){
  document.getElementById("score").textContent=score;
  if(score>best){
    best=score;
    localStorage.setItem("best",best);
    document.getElementById("best").textContent=best;
  }
  updateLocks();
}

function updateLocks(){
  lock("r2048",best<25000);
  lock("r4096",best<50000);
  lock("r8192",best<100000);
}

function lock(id,state){
  document.getElementById(id).classList.toggle("locked",state);
}

function specialReset(v,s,m){
  if((m==1&&best<25000)||(m==2&&best<50000)||(m==3&&best<100000)){
    alert("ミッション"+m+"をクリアすると解放");
    return;
  }
  score=s;
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  board[0][0]=v;
  update();draw();
}

function fullReset(){init();}

function endGame(){
  document.getElementById("finalScore").textContent="Score: "+score;
  document.getElementById("newRecord").textContent=score===best?"New Record!":"";
  document.getElementById("gameover").style.display="flex";
}

function info(){
  alert("最高スコアが一定値に到達すると、特定タイルからゲームを開始できます");
}

init();
</script>
</body>
</html>
