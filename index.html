<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My2048</title>

<style>
*{
  box-sizing:border-box;
  user-select:none;
  -webkit-user-select:none;
}
body{
  margin:0;
  background:#faf6f0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI";
  text-align:center;
}

h1{margin:16px 0 6px;}

#scorebar{
  display:flex;
  justify-content:center;
  gap:24px;
  font-size:18px;
}

#board{
  width:90vw;
  max-width:320px;
  aspect-ratio:1/1;
  margin:20px auto;
  background:#bbada0;
  border-radius:12px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  grid-template-rows:repeat(4,1fr);
  gap:10px;
  padding:10px;
}

.cell{
  background:#cdc1b4;
  border-radius:8px;
  position:relative;
}

.tile{
  position:absolute;
  inset:0;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:24px;
  transition:transform .25s ease; /* ← ここがゆっくり */
}

.controls button,
.resetRow button{
  font-size:16px;
  padding:6px 12px;
  margin:4px;
}

button.locked{
  background:#ccc;
  color:#666;
}

#lockSelect:disabled{
  background:#ccc;
  color:#666;
}

.infoBtn{
  font-size:14px;
  padding:2px 6px;
  margin-left:6px;
}

.hidden{display:none;}

#gameover{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
#gameover.show{display:flex;}

#gameoverContent{
  background:#fff;
  padding:20px;
  border-radius:12px;
}
</style>
</head>

<body>

<h1>2048</h1>

<div id="scorebar">
  <div>Score: <span id="score">0</span></div>
  <div>Best: <span id="best">0</span></div>
</div>

<div>
  <select id="lockSelect" disabled>
    <option value="">方向ロックなし</option>
    <option value="up">↑ 上</option>
    <option value="down">↓ 下</option>
    <option value="left">← 左</option>
    <option value="right">→ 右</option>
  </select>
  <button class="infoBtn"
   onclick="alert('任意の1方向を選ぶと、その方向に動かす前に確認が入ります')">i</button>
</div>

<div id="board"></div>

<div class="controls">
  <div><button onclick="move('up')">↑</button></div>
  <div>
    <button onclick="move('left')">←</button>
    <button onclick="move('down')">↓</button>
    <button onclick="move('right')">→</button>
  </div>
</div>

<button onclick="restart()">RESET</button>

<div class="resetRow">
  <button id="r2048" onclick="specialReset(2048)">2048</button>
  <button id="r4096" onclick="specialReset(4096)">4096</button>
  <button id="r8192" onclick="specialReset(8192)">8192</button>
  <button class="infoBtn"
   onclick="alert('特定のタイルがある状態からリセットできます')">i</button>
</div>

<div id="gameover">
  <div id="gameoverContent">
    <h2>Game Over</h2>
    <p>Score: <span id="finalScore"></span></p>
    <button onclick="restart()">Restart</button>
  </div>
</div>

<script>
const SIZE=4;
let board, score=0, best=0, gameOver=false;
let lockedDirection="";

const missions={
  m1:false,m2:false,m3:false,m4:false,m5:false,
  m6:false,m7:false,m8:false,m9:false,m10:false,m11:false
};

const boardEl=document.getElementById("board");
const bestEl=document.getElementById("best");
const lockSelect=document.getElementById("lockSelect");

function init(){
  boardEl.innerHTML="";
  for(let i=0;i<16;i++){
    const c=document.createElement("div");
    c.className="cell";
    boardEl.appendChild(c);
  }

  board=[...Array(4)].map(()=>Array(4).fill(0));
  spawn(); spawn();
  score=0;
  best=Number(localStorage.getItem("best")||0);
  draw();
}

function spawn(){
  const e=[];
  for(let r=0;r<4;r++)for(let c=0;c<4;c++)
    if(board[r][c]===0) e.push([r,c]);
  if(!e.length) return;
  const [r,c]=e[Math.random()*e.length|0];
  board[r][c]=Math.random()<0.9?2:4;
}

function draw(){
  [...boardEl.children].forEach(c=>c.innerHTML="");
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    const v=board[r][c];
    if(v){
      const t=document.createElement("div");
      t.className="tile";
      t.textContent=v;
      boardEl.children[r*4+c].appendChild(t);
    }
  }
  document.getElementById("score").textContent=score;
  bestEl.textContent=best;
  updateBestColor();
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]===arr[i+1]){
      arr[i]*=2;
      score+=arr[i];
      arr[i+1]=0;
    }
  }
  arr=arr.filter(v=>v);
  while(arr.length<4) arr.push(0);
  return arr;
}

function move(dir){
  if(gameOver) return;
  if(lockedDirection===dir && !confirm("この方向はロックされています")) return;

  let moved=false;
  for(let i=0;i<4;i++){
    let line=[];
    for(let j=0;j<4;j++){
      let r=i,c=j;
      if(dir==="up"){r=j;c=i;}
      if(dir==="down"){r=3-j;c=i;}
      if(dir==="right"){r=i;c=3-j;}
      line.push(board[r][c]);
    }
    const sl=slide(line);
    for(let j=0;j<4;j++){
      let r=i,c=j;
      if(dir==="up"){r=j;c=i;}
      if(dir==="down"){r=3-j;c=i;}
      if(dir==="right"){r=i;c=3-j;}
      if(board[r][c]!==sl[j]) moved=true;
      board[r][c]=sl[j];
    }
  }
  if(moved){
    spawn();
    if(score>best){best=score;localStorage.setItem("best",best);}
    draw();
    if(!canMove()) endGame();
  }
}

function canMove(){
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    if(board[r][c]===0) return true;
    if(r<3 && board[r][c]===board[r+1][c]) return true;
    if(c<3 && board[r][c]===board[r][c+1]) return true;
  }
  return false;
}

function endGame(){
  gameOver=true;
  document.getElementById("finalScore").textContent=score;
  document.getElementById("gameover").classList.add("show");
}

function restart(){
  gameOver=false;
  document.getElementById("gameover").classList.remove("show");
  init();
}

function specialReset(v){
  board=[...Array(4)].map(()=>Array(4).fill(0));
  board[0][0]=v;
  score = v===2048?20100 : v===4096?44400 : 96900;
  draw();
}

function updateBestColor(){
  bestEl.style.color="#000";
  if(missions.m5) bestEl.style.color="red";
  if(missions.m6) bestEl.style.color="purple";
  if(missions.m7) bestEl.style.color="pink";
}

init();
</script>
</body>
</html>
