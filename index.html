<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>My2048</title>

<style>
*{
  box-sizing:border-box;
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
}
html,body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI";
  background:#faf6f0;
  overscroll-behavior:none;
  touch-action:manipulation;
  text-align:center;
}

h1{margin:14px 0 6px;}

#scorebar{
  display:flex;
  justify-content:center;
  gap:20px;
  font-size:18px;
}

#board{
  width:90vw;
  max-width:320px;
  aspect-ratio:1/1;
  margin:16px auto;
  background:#bbada0;
  border-radius:12px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  grid-template-rows:repeat(4,1fr);
  gap:10px;
  padding:10px;
  touch-action:none;
}

.cell{
  background:#cdc1b4;
  border-radius:8px;
  position:relative;
}

.tile{
  position:absolute;
  inset:0;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:24px;
  transition:transform .22s ease;
}

.tile.merge{animation:merge .18s;}
@keyframes merge{
  0%{transform:scale(1)}
  50%{transform:scale(1.18)}
  100%{transform:scale(1)}
}

.tile.spawn{
  box-shadow:0 0 0 8px rgba(255,255,255,.9);
}

button{font-size:15px;padding:6px 10px;margin:4px;}
button.locked{background:#ccc;color:#666;}

.infoBtn{
  font-size:14px;
  padding:2px 6px;
  border-radius:4px;
  background:#ddd;
  border:none;
}

#gameover{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:10;
}
#gameover.show{display:flex;}

#gameoverContent{
  background:#fff;
  padding:20px;
  border-radius:12px;
}

.missionPanel{
  max-width:320px;
  margin:10px auto;
  background:#f3efe8;
  border-radius:10px;
  padding:10px;
  text-align:left;
}
.hidden{display:none;}

.missionPanel li{
  display:flex;
  gap:8px;
  font-size:14px;
  padding:4px 0;
}
.missionPanel li.done{color:#999;}

#notify{
  position:fixed;
  top:10px;right:10px;
  background:#fffae0;
  padding:8px 12px;
  border-radius:6px;
  display:none;
  font-weight:bold;
}
</style>
</head>

<body>

<h1>2048</h1>
<div id="scorebar">
  <div>Score: <span id="score">0</span></div>
  <div>Best: <span id="best">0</span></div>
</div>

<div>
  <select id="lockSelect">
    <option value="">方向ロックなし</option>
    <option value="up">↑ 上</option>
    <option value="down">↓ 下</option>
    <option value="left">← 左</option>
    <option value="right">→ 右</option>
  </select>
  <button class="infoBtn" onclick="alert('任意の1方向を選ぶと、その方向に動かす前に確認が入ります')">i</button>
</div>

<div id="board"></div>

<div>
  <button onclick="move('up')">↑</button><br>
  <button onclick="move('left')">←</button>
  <button onclick="move('down')">↓</button>
  <button onclick="move('right')">→</button>
</div>

<button onclick="resetGame()">RESET</button>

<div>
  <button id="r2048" onclick="specialReset(2048)">2048</button>
  <button id="r4096" onclick="specialReset(4096)">4096</button>
  <button id="r8192" onclick="specialReset(8192)">8192</button>
  <button class="infoBtn" onclick="alert('特定のタイルがある状態からリセットできます')">i</button>
</div>

<button onclick="toggleMission()">ミッション</button>
<div id="missionPanel" class="missionPanel hidden">
  <ul id="missionList"></ul>
</div>

<div id="notify"></div>

<div id="gameover">
  <div id="gameoverContent">
    <h2>Game Over</h2>
    <p>Score: <span id="finalScore"></span></p>
    <p id="newRecord" class="hidden">New Record!</p>
    <button onclick="restart()">Restart</button>
  </div>
</div>

<script>
const SIZE=4;
let board,score=0,best=0,gameOver=false;
let startX=0,startY=0,locked="";

const colors={
2:"#eee4da",4:"#ede0c8",8:"#f2b179",16:"#f59563",
32:"#f67c5f",64:"#f65e3b",128:"#edcf72",
256:"#edcc61",512:"#edc850",1024:"#edc53f",
2048:"#edc22e",4096:"#3c3a32",
8192:"#7b3fe4",16384:"#f08",32768:"#fff"
};

const missions=JSON.parse(localStorage.getItem("missions")||"{}");

const missionText=[
"★☆☆☆☆Mission 1 : 25000点到達",
"★☆☆☆☆Mission 2 : 50000点到達",
"★★☆☆☆Mission 3 : 100000点到達",
"★★★☆☆Mission 4 : 150000点到達",
"★★★★☆Mission 5 : 225000点到達",
"★★★★☆Mission 6 : 300000点到達",
"★★★★★Mission 7 : 450000点到達",
"★☆☆☆☆Mission 8 : 500点以下でゲームオーバーになる",
"★★☆☆☆Mission 9 : 300点以下でゲームオーバーになる",
"★★★☆☆Mission 10 : 150点以下でゲームオーバーになる",
"★★★★☆Mission 11 : 2048を同時に3つ作る"
];

function init(){
  best=+localStorage.getItem("best")||0;
  const save=JSON.parse(localStorage.getItem("save")||"null");
  board=save?.board||[...Array(4)].map(()=>Array(4).fill(0));
  score=save?.score||0;
  if(!save){spawn();spawn();}
  draw();update();
}

function spawn(v){
  const empty=[];
  board.forEach((r,i)=>r.forEach((c,j)=>{if(!c)empty.push([i,j])}));
  if(!empty.length)return;
  const [r,c]=empty[Math.random()*empty.length|0];
  board[r][c]=v|| (Math.random()<0.9?2:4);
}

function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  board.flat().forEach(v=>{
    const cell=document.createElement("div");
    cell.className="cell";
    if(v){
      const t=document.createElement("div");
      t.className="tile";
      t.textContent=v;
      t.style.background=colors[v];
      t.style.color=v>=4096?"#fff":"#000";
      cell.appendChild(t);
    }
    b.appendChild(cell);
  });
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]==arr[i+1]){
      arr[i]*=2; score+=arr[i];
      arr[i+1]=0;
    }
  }
  arr=arr.filter(v=>v);
  while(arr.length<4)arr.push(0);
  return arr;
}

function move(dir){
  if(gameOver)return;
  if(locked===dir && !confirm("この方向はロックされています。動かしますか？"))return;
  let moved=false;
  for(let i=0;i<4;i++){
    let line=[];
    for(let j=0;j<4;j++){
      let r=i,c=j;
      if(dir=="up"){r=j;c=i}
      if(dir=="down"){r=3-j;c=i}
      if(dir=="right"){r=i;c=3-j}
      line.push(board[r][c]);
    }
    const sl=slide(line);
    for(let j=0;j<4;j++){
      let r=i,c=j;
      if(dir=="up"){r=j;c=i}
      if(dir=="down"){r=3-j;c=i}
      if(dir=="right"){r=i;c=3-j}
      if(board[r][c]!=sl[j])moved=true;
      board[r][c]=sl[j];
    }
  }
  if(moved){
    spawn();
    if(score>best){best=score;localStorage.setItem("best",best);}
    checkMissions();
    update();
    if(!canMove()) endGame();
  }
}

function canMove(){
  for(let r=0;r<4;r++)for(let c=0;c<4;c++){
    if(!board[r][c])return true;
    if(r<3&&board[r][c]==board[r+1][c])return true;
    if(c<3&&board[r][c]==board[r][c+1])return true;
  }
  return false;
}

function update(){
  document.getElementById("score").textContent=score;
  document.getElementById("best").textContent=best;
  localStorage.setItem("save",JSON.stringify({board,score}));
}

function endGame(){
  gameOver=true;
  document.getElementById("finalScore").textContent=score;
  document.getElementById("newRecord").classList.toggle("hidden",score<best);
  document.getElementById("gameover").classList.add("show");
  localStorage.removeItem("save");
}

function restart(){
  gameOver=false;
  document.getElementById("gameover").classList.remove("show");
  score=0;
  board=[...Array(4)].map(()=>Array(4).fill(0));
  spawn();spawn();update();
}

function resetGame(){
  if(confirm("リセットしますか？")) restart();
}

function specialReset(v){
  if(v==2048&&!missions[1])return alert("Mission1クリアで解放");
  if(v==4096&&!missions[2])return alert("Mission2クリアで解放");
  if(v==8192&&!missions[3])return alert("Mission3クリアで解放");
  board=[...Array(4)].map(()=>Array(4).fill(0));
  spawn(v);
  score={2048:20100,4096:44400,8192:96900}[v];
  update();
}

function toggleMission(){
  document.getElementById("missionPanel").classList.toggle("hidden");
  const ul=document.getElementById("missionList");
  ul.innerHTML="";
  missionText.forEach((t,i)=>{
    const li=document.createElement("li");
    if(missions[i+1])li.classList.add("done");
    li.textContent=t+(missions[i+1]?"  済":"  未");
    ul.appendChild(li);
  });
}

function checkMissions(){
  if(best>=25000)missions[1]=true;
  if(best>=50000)missions[2]=true;
  if(best>=100000)missions[3]=true;
  if(best>=150000)missions[4]=true;
  if(best>=225000)missions[5]=true;
  if(best>=300000)missions[6]=true;
  if(best>=450000)missions[7]=true;

  let count2048=0;
  board.flat().forEach(v=>{if(v==2048)count2048++;});
  if(count2048>=3)missions[11]=true;

  localStorage.setItem("missions",JSON.stringify(missions));
}

document.getElementById("lockSelect").onchange=e=>{
  if(!missions[4]){alert("Mission4クリアで解放");e.target.value="";return;}
  locked=e.target.value;
};

const boardEl=document.getElementById("board");
boardEl.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  startX=t.clientX;startY=t.clientY;
},{passive:false});

boardEl.addEventListener("touchend",e=>{
  const t=e.changedTouches[0];
  const dx=t.clientX-startX;
  const dy=t.clientY-startY;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>30)move("right");
    if(dx<-30)move("left");
  }else{
    if(dy>30)move("down");
    if(dy<-30)move("up");
  }
},{passive:false});

init();
</script>
</body>
</html>
