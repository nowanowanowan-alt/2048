<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2048 Ultimate</title>

<style>
*{
  box-sizing:border-box;
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
}
body{
  margin:0;
  background:#faf6f0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI";
  text-align:center;
  overscroll-behavior:none;
}

html, body { touch-action: manipulation; }

h1{margin:16px 0 6px;}

#scorebar{
  display:flex;
  justify-content:center;
  gap:24px;
  font-size:18px;
}

#board{
  width:90vw;
  max-width:320px;
  aspect-ratio:1/1;
  margin:20px auto;
  background:#bbada0;
  border-radius:12px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  grid-template-rows:repeat(4,1fr);
  gap:10px;
  padding:10px;
  touch-action:none;
}

.cell{
  background:#cdc1b4;
  border-radius:8px;
  position:relative;
}

.tile{
  position:absolute;
  inset:0;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:24px;
  transition:transform .15s ease;
}

.tile.merge{ animation:merge .15s; }
@keyframes merge{
  0%{transform:scale(1)}
  50%{transform:scale(1.15)}
  100%{transform:scale(1)}
}

.tile.spawn{
  box-shadow:0 0 0 3px rgba(255,255,255,.9);
}

.controls button,
.resetRow button{
  font-size:16px;
  padding:6px 12px;
  margin:4px;
}

button.locked{
  background:#ccc;
  color:#666;
}

#missionBtn{margin-top:10px;}

.missionPanel{
  max-width:320px;
  margin:10px auto 0;
  padding:12px;
  background:#f3efe8;
  border-radius:10px;
  text-align:left;
}
.missionPanel ul{
  list-style:none;
  padding:0;
  margin:0;
}
.missionPanel li{
  font-size:14px;
  padding:6px 0;
  display:flex;
  gap:8px;
}
.missionPanel li.done{color:#999;}

.hidden{display:none;}

#gameover{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:10;
}
#gameover.show{display:flex;}

#gameoverContent{
  background:#fff;
  color:#000;
  padding:20px;
  border-radius:12px;
}

#lockControl{
  margin-top:10px;
}
#lockSelect{
  font-size:14px;
  padding:4px 8px;
}
.infoBtn{
  cursor:pointer;
  font-size:14px;
  margin-left:6px;
  padding:2px 6px;
  border-radius:4px;
  background:#ddd;
  border:none;
}
#achievement{margin-top:6px;font-size:14px;}
</style>
</head>

<body>

<h1>2048</h1>
<div id="scorebar">
  <div>Score: <span id="score">0</span></div>
  <div>Best: <span id="best">0</span></div>
</div>

<div id="lockControl">
  <select id="lockSelect" disabled>
    <option value="">æ–¹å‘ãƒ­ãƒƒã‚¯ (Mission4ã§è§£æ”¾)</option>
    <option value="up">â†‘ ä¸Š</option>
    <option value="down">â†“ ä¸‹</option>
    <option value="left">â† å·¦</option>
    <option value="right">â†’ å³</option>
  </select>
  <button class="infoBtn" onclick="alert('ä»»æ„ã®1æ–¹å‘ã‚’é¸ã¶ã¨ã€ãã®æ–¹å‘ã«å‹•ã‹ã™å‰ã«ç¢ºèªãŒå…¥ã‚Šã¾ã™')">i</button>
</div>

<div id="board"></div>

<div class="controls">
  <div><button onclick="move('up')">â†‘</button></div>
  <div>
    <button onclick="move('left')">â†</button>
    <button onclick="move('down')">â†“</button>
    <button onclick="move('right')">â†’</button>
  </div>
</div>

<button onclick="resetConfirm()">RESET</button>

<div class="resetRow">
  <button id="r2048" onclick="specialReset(2048)">2048</button>
  <button id="r4096" onclick="specialReset(4096)">4096</button>
  <button id="r8192" onclick="specialReset(8192)">8192</button>
  <button class="infoBtn" onclick="alert('ç‰¹å®šã®ã‚¿ã‚¤ãƒ«ãŒã‚ã‚‹çŠ¶æ…‹ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆã§ãã¾ã™')">i</button>
</div>

<button id="missionBtn">ğŸ“˜ ãƒŸãƒƒã‚·ãƒ§ãƒ³</button>
<div id="missionPanel" class="missionPanel hidden">
  <ul id="missionList"></ul>
  <div id="achievement"></div>
</div>

<div id="gameover">
  <div id="gameoverContent">
    <h2>Game Over</h2>
    <p>Score: <span id="finalScore"></span></p>
    <p id="newRecord" class="hidden">ğŸ‰ New Record!</p>
    <button onclick="restart()">Restart</button>
  </div>
</div>

<script>
const SIZE=4;
let board=[], score=0, best=0, gameOver=false;
let startX=0,startY=0,touching=false;
let lockedDirection="";

const colors={
  2:"#fff",4:"#f5d7b2",8:"#f2b179",16:"#f59563",
  32:"#f67c5f",64:"#f65e3b",
  128:"#edcf72",256:"#edcc61",512:"#edc850",
  1024:"#edc53f",2048:"#edc22e",
  4096:"#000",8192:"#7b3fe4",16384:"#f08",32768:"#fff"
};

const missions={
  m1:false,m2:false,m3:false,m4:false,m5:false,
  m6:false,m7:false,m8:false,m9:false,m10:false
};

const missionData=[
 {id:1,star:"â˜…â˜†â˜†â˜†â˜†",text:"Mission 1 : 25000ç‚¹åˆ°é” (2048)"},
 {id:2,star:"â˜…â˜†â˜†â˜†â˜†",text:"Mission 2 : 50000ç‚¹åˆ°é” (4096)"},
 {id:3,star:"â˜…â˜…â˜†â˜†â˜†",text:"Mission 3 : 100000ç‚¹åˆ°é” (8192)"},
 {id:4,star:"â˜…â˜…â˜…â˜†â˜†",text:"Mission 4 : 150000ç‚¹åˆ°é”"},
 {id:5,star:"â˜…â˜…â˜…â˜…â˜†",text:"Mission 5 : 225000ç‚¹åˆ°é” (16384)"},
 {id:6,star:"â˜…â˜…â˜…â˜…â˜†",text:"Mission 6 : 300000ç‚¹åˆ°é”"},
 {id:7,star:"â˜…â˜…â˜…â˜…â˜…",text:"Mission 7 : 450000ç‚¹åˆ°é” (32768)"},
 {id:8,star:"â˜…â˜†â˜†â˜†â˜†",text:"Mission 8 : 750ç‚¹ä»¥ä¸‹ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼"},
 {id:9,star:"â˜…â˜…â˜†â˜†â˜†",text:"Mission 9 : 500ç‚¹ä»¥ä¸‹ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼"},
 {id:10,star:"â˜…â˜…â˜…â˜†â˜†",text:"Mission 10 : 300ç‚¹ä»¥ä¸‹ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼"}
];

const boardElem=document.getElementById("board");
const bestElem=document.getElementById("best");
const lockSelect=document.getElementById("lockSelect");
const achievementElem=document.getElementById("achievement");

function init(){
  boardElem.innerHTML="";
  gameOver=false;
  document.getElementById("gameover").classList.remove("show");

  for(let i=0;i<SIZE*SIZE;i++){
    const c=document.createElement("div");
    c.className="cell";
    boardElem.appendChild(c);
  }

  const save=localStorage.getItem("save");
  const ms=localStorage.getItem("missions");
  if(ms) Object.assign(missions,JSON.parse(ms));

  if(save){
    const d=JSON.parse(save);
    board=d.board; score=d.score;
  }else{
    board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
    spawn(); spawn();
  }

  best=Number(localStorage.getItem("best")||0);
  update();
  updateMissionButtons();
}

function spawn(){
  const e=[];
  for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++)
    if(board[r][c]==0)e.push([r,c]);
  if(!e)return;
  const [r,c]=e[Math.random()*e.length|0];
  board[r][c]=Math.random()<0.9?2:4;
}

function draw(){
  const cells=[...boardElem.children];
  cells.forEach(c=>c.innerHTML="");
  for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
    const v=board[r][c];
    if(v){
      const t=document.createElement("div");
      t.className="tile";
      t.textContent=v;
      t.style.background=colors[v]||"#000";
      t.style.color=v>=4096?"#fff":"#000";
      cells[r*SIZE+c].appendChild(t);
    }
  }
}

function update(){
  document.getElementById("score").textContent=score;
  bestElem.textContent=best;
  draw();
  localStorage.setItem("save",JSON.stringify({board,score}));
  localStorage.setItem("missions",JSON.stringify(missions));
  updateBestColor();
}

function updateBestColor(){
  if(missions.m7) bestElem.style.color="pink";
  else if(missions.m6) bestElem.style.color="purple";
  else if(missions.m5) bestElem.style.color="red";
  else bestElem.style.color="#000";
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]==arr[i+1]){
      arr[i]*=2;
      score+=arr[i];
      arr[i+1]=0;
    }
  }
  arr=arr.filter(v=>v);
  while(arr.length<SIZE)arr.push(0);
  return arr;
}

function move(dir){
  if(gameOver) return;
  if(lockedDirection && lockedDirection===dir){
    if(!confirm("ã“ã®æ–¹å‘ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ¬å½“ã«å‹•ã‹ã—ã¾ã™ã‹ï¼Ÿ")) return;
  }

  let moved=false;
  for(let i=0;i<SIZE;i++){
    let line=[];
    for(let j=0;j<SIZE;j++){
      let r=i,c=j;
      if(dir=="up"){r=j;c=i;}
      if(dir=="down"){r=SIZE-1-j;c=i;}
      if(dir=="right"){r=i;c=SIZE-1-j;}
      line.push(board[r][c]);
    }
    const sl=slide(line);
    for(let j=0;j<SIZE;j++){
      let r=i,c=j;
      if(dir=="up"){r=j;c=i;}
      if(dir=="down"){r=SIZE-1-j;c=i;}
      if(dir=="right"){r=i;c=SIZE-1-j;}
      if(board[r][c]!=sl[j]) moved=true;
      board[r][c]=sl[j];
    }
  }
  if(moved){
    spawn();
    if(score>best){best=score;localStorage.setItem("best",best);}
    checkMissions();
    update();
    if(!canMove()) endGame();
  }
}

function canMove(){
  for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
    if(board[r][c]==0) return true;
    if(r<3 && board[r][c]==board[r+1][c]) return true;
    if(c<3 && board[r][c]==board[r][c+1]) return true;
  }
  return false;
}

function endGame(){
  gameOver=true;
  localStorage.removeItem("save");
  document.getElementById("finalScore").textContent=score;
  document.getElementById("newRecord").classList.toggle("hidden",score<best);

  // ãƒŸãƒƒã‚·ãƒ§ãƒ³8ã€œ10ã®ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¡ä»¶åˆ¤å®š
  if(score<=750) missions.m8=true;
  if(score<=500) missions.m9=true;
  if(score<=300) missions.m10=true;

  document.getElementById("gameover").classList.add("show");
  renderMissionList();
}

function restart(){
  gameOver=false;
  document.getElementById("gameover").classList.remove("show");
  localStorage.removeItem("save");
  score=0;
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  spawn(); spawn();
  update();
}

function resetConfirm(){
  if(confirm("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) restart();
}

function specialReset(v){
  if(v===2048 && !missions.m1){ alert("Mission1ã‚¯ãƒªã‚¢ã§è§£æ”¾"); return; }
  if(v===4096 && !missions.m2){ alert("Mission2ã‚¯ãƒªã‚¢ã§è§£æ”¾"); return; }
  if(v===8192 && !missions.m3){ alert("Mission3ã‚¯ãƒªã‚¢ã§è§£æ”¾"); return; }

  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  board[0][0]=v;
  score = (v===2048)?20100:(v===4096)?44400:96900;
  update();
}

function checkMissions(){
  if(score>=25000) missions.m1=true;
  if(score>=50000) missions.m2=true;
  if(score>=100000) missions.m3=true;
  if(score>=150000) missions.m4=true;
  if(score>=225000) missions.m5=true;
  if(score>=300000) missions.m6=true;
  if(score>=450000) missions.m7=true;

  // unlock direction if mission4 cleared
  lockSelect.disabled=!missions.m4;

  updateMissionButtons();
}

function updateMissionButtons(){
  document.getElementById("r2048").className=missions.m1?"":"locked";
  document.getElementById("r4096").className=missions.m2?"":"locked";
  document.getElementById("r8192").className=missions.m3?"":"locked";
}

document.getElementById("missionBtn").onclick=()=>{
  document.getElementById("missionPanel").classList.toggle("hidden");
  renderMissionList();
};

function renderMissionList(){
  const list=document.getElementById("missionList");
  list.innerHTML="";

  let clearedCount=0;
  missionData.forEach(m=>{
    const cleared = missions["m"+m.id];
    if(cleared) clearedCount++;

    const li=document.createElement("li");
    if(cleared) li.classList.add("done");

    li.innerHTML = `
      <span style="width:3em">${m.star}</span>
      <span style="flex:1">${m.text}</span>
      <span style="width:3em;text-align:right">
        ${cleared ? "æ¸ˆ" : "æœª"}
      </span>
    `;
    list.appendChild(li);
  });
  achievementElem.textContent = `ãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆåº¦: ${clearedCount}/10`;
}

lockSelect.onchange = ()=>{
  if(!missions.m4){
    alert("Mission 4ã‚¯ãƒªã‚¢ã§è§£æ”¾");
    lockSelect.value="";
    return;
  }
  lockedDirection = lockSelect.value;
}

boardElem.addEventListener("touchstart",e=>{
  touching=true;
  const t=e.touches[0];
  startX=t.clientX; startY=t.clientY;
},{passive:false});

boardElem.addEventListener("touchend",e=>{
  if(!touching) return;
  touching=false;
  const t=e.changedTouches[0];
  const dx=t.clientX-startX;
  const dy=t.clientY-startY;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>30) move("right");
    else if(dx<-30) move("left");
  }else{
    if(dy>30) move("down");
    else if(dy<-30) move("up");
  }
});

init();

let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, { passive: false });

</script>
</body>
</html>
