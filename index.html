<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2048</title>

<style>
*{
  box-sizing:border-box;
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
}

body{
  margin:0;
  background:#faf6f0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  text-align:center;
}

h1{ margin:16px 0 4px; }

#scorebar{
  display:flex;
  justify-content:center;
  gap:24px;
  font-size:18px;
}

#board{
  width:90vw;
  max-width:320px;
  aspect-ratio:1/1;
  margin:20px auto;
  background:#bbada0;
  border-radius:10px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  grid-template-rows:repeat(4,1fr);
  gap:10px;
  padding:10px;
  touch-action:none;
}

.cell{
  background:#cdc1b4;
  border-radius:6px;
  position:relative;
}

.tile{
  position:absolute;
  inset:0;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  font-weight:bold;
  animation: pop 0.15s ease;
}

@keyframes pop{
  from{ transform:scale(0.8); }
  to{ transform:scale(1); }
}

.tile.new{
  box-shadow:0 0 0 3px rgba(255,255,255,0.8);
}

.controls{
  margin-top:10px;
}

.controls button{
  font-size:18px;
  margin:4px;
  padding:8px 14px;
}

#missionBtn{
  margin-top:10px;
  font-size:16px;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:flex;
  justify-content:center;
  align-items:center;
}

.hidden{ display:none; }

.modalContent{
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:80%;
  max-width:300px;
}

#gameover{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  color:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}

</style>
</head>

<body>

<h1>2048</h1>
<div id="scorebar">
  <div>Score: <span id="score">0</span></div>
  <div>Best: <span id="best">0</span></div>
</div>

<div id="board"></div>

<div class="controls">
  <div>
    <button onclick="move('up')">‚Üë</button>
  </div>
  <div>
    <button onclick="move('left')">‚Üê</button>
    <button onclick="move('down')">‚Üì</button>
    <button onclick="move('right')">‚Üí</button>
  </div>
</div>

<button id="missionBtn">üìú „Éü„ÉÉ„Ç∑„Éß„É≥</button>

<div id="missionModal" class="modal hidden">
  <div class="modalContent">
    <h3>„Éü„ÉÉ„Ç∑„Éß„É≥</h3>
    <ul>
      <li>25000ÁÇπÂà∞ÈÅî</li>
      <li>50000ÁÇπÂà∞ÈÅî</li>
      <li>100000ÁÇπÂà∞ÈÅî</li>
      <li>750ÁÇπ‰ª•‰∏ã„ÅßGame Over</li>
    </ul>
    <button onclick="closeMission()">Èñâ„Åò„Çã</button>
  </div>
</div>

<div id="gameover" class="hidden">
  <h2>Game Over</h2>
  <button onclick="restart()">Restart</button>
</div>

<script>
const SIZE=4;
let board=[], score=0, best=0;
let startX=0, startY=0, touching=false;

const boardElem=document.getElementById("board");

function init(){
  boardElem.innerHTML="";
  board=[];
  for(let i=0;i<SIZE*SIZE;i++){
    const c=document.createElement("div");
    c.className="cell";
    boardElem.appendChild(c);
  }

  const saved=localStorage.getItem("save");
  if(saved){
    const d=JSON.parse(saved);
    board=d.board;
    score=d.score;
  }else{
    board=Array.from({length:SIZE},()=>Array(SIZE).fill(0));
    spawn(); spawn();
  }

  best=Number(localStorage.getItem("best")||0);
  update();
}

function spawn(){
  const empty=[];
  for(let r=0;r<SIZE;r++)
    for(let c=0;c<SIZE;c++)
      if(board[r][c]==0) empty.push([r,c]);

  if(empty.length==0) return;
  const [r,c]=empty[Math.floor(Math.random()*empty.length)];
  board[r][c]=Math.random()<0.9?2:4;
}

function draw(){
  const cells=[...boardElem.children];
  cells.forEach(c=>c.innerHTML="");

  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      const v=board[r][c];
      if(v){
        const t=document.createElement("div");
        t.className="tile";
        t.textContent=v;
        t.style.background="#eee4da";
        t.style.color="#000";
        cells[r*SIZE+c].appendChild(t);
      }
    }
  }
}

function update(){
  document.getElementById("score").textContent=score;
  document.getElementById("best").textContent=best;
  draw();
  localStorage.setItem("save",JSON.stringify({board,score}));
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]==arr[i+1]){
      arr[i]*=2;
      score+=arr[i];
      arr[i+1]=0;
    }
  }
  arr=arr.filter(v=>v);
  while(arr.length<SIZE) arr.push(0);
  return arr;
}

function move(dir){
  let moved=false;
  for(let i=0;i<SIZE;i++){
    let line=[];
    for(let j=0;j<SIZE;j++){
      let r=i,c=j;
      if(dir=="up"){ r=j; c=i; }
      if(dir=="down"){ r=SIZE-1-j; c=i; }
      if(dir=="right"){ r=i; c=SIZE-1-j; }
      line.push(board[r][c]);
    }
    let sl=slide(line);
    for(let j=0;j<SIZE;j++){
      let r=i,c=j;
      if(dir=="up"){ r=j; c=i; }
      if(dir=="down"){ r=SIZE-1-j; c=i; }
      if(dir=="right"){ r=i; c=SIZE-1-j; }
      if(board[r][c]!=sl[j]) moved=true;
      board[r][c]=sl[j];
    }
  }
  if(moved){
    spawn();
    if(score>best){
      best=score;
      localStorage.setItem("best",best);
    }
    update();
    if(!canMove()) gameOver();
  }
}

function canMove(){
  for(let r=0;r<SIZE;r++)
    for(let c=0;c<SIZE;c++){
      if(board[r][c]==0) return true;
      if(r<3&&board[r][c]==board[r+1][c]) return true;
      if(c<3&&board[r][c]==board[r][c+1]) return true;
    }
  return false;
}

function gameOver(){
  localStorage.removeItem("save");
  document.getElementById("gameover").classList.remove("hidden");
}

function restart(){
  document.getElementById("gameover").classList.add("hidden");
  localStorage.removeItem("save");
  score=0;
  init();
}

boardElem.addEventListener("touchstart",e=>{
  touching=true;
  const t=e.touches[0];
  startX=t.clientX; startY=t.clientY;
},{passive:false});

boardElem.addEventListener("touchend",e=>{
  if(!touching) return;
  touching=false;
  const t=e.changedTouches[0];
  const dx=t.clientX-startX;
  const dy=t.clientY-startY;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>30) move("right");
    else if(dx<-30) move("left");
  }else{
    if(dy>30) move("down");
    else if(dy<-30) move("up");
  }
});

function closeMission(){
  document.getElementById("missionModal").classList.add("hidden");
}
document.getElementById("missionBtn").onclick=()=>{
  document.getElementById("missionModal").classList.remove("hidden");
};

init();
</script>
</body>
</html>
