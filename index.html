<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>2048</title>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:#faf8ef;
  overscroll-behavior:none;
  touch-action:none;
}
#game{width:320px;margin:15px auto;}
.header{
  display:flex;
  justify-content:space-between;
}
.scorebox{
  background:#bbada0;
  color:white;
  padding:6px 10px;
  border-radius:6px;
  font-size:14px;
  text-align:center;
}
#board{
  margin-top:10px;
  background:#bbada0;
  padding:10px;
  border-radius:8px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
}
.cell{
  width:70px;height:70px;
  background:#cdc1b4;
  border-radius:6px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:22px;
  font-weight:bold;
  transition:transform .12s ease-in-out;
}
.spawn{animation:spawn .15s ease-out,glow .3s ease-out;}
.merge{animation:merge .18s ease-out;}

@keyframes spawn{from{transform:scale(0)}to{transform:scale(1)}}
@keyframes merge{
  0%{transform:scale(1)}
  50%{transform:scale(1.25)}
  100%{transform:scale(1)}
}
@keyframes glow{
  0%{box-shadow:0 0 0 rgba(255,255,255,0)}
  50%{box-shadow:0 0 12px rgba(255,255,255,.9)}
  100%{box-shadow:0 0 0 rgba(255,255,255,0)}
}

/* tile colors */
.n2{background:#fff}
.n4{background:#f5e0c3}
.n8{background:#f2b179;color:#fff}
.n16{background:#f59563;color:#fff}
.n32{background:#f67c5f;color:#fff}
.n64{background:#f65e3b;color:#fff}
.n128,.n256,.n512,.n1024,.n2048{background:#edcf72}
.n4096{background:#000;color:#fff}
.n8192{background:purple;color:#fff}
.n16384{background:pink}
.n32768{background:#fff}

/* reset + info */
.reset-area{
  display:flex;
  gap:6px;
  margin-top:8px;
  justify-content:center;
}
.reset-area button{
  padding:6px;
  font-size:12px;
  border:none;
  border-radius:6px;
}
.locked{background:#aaa;color:#555}
.info{width:32px;height:32px;border-radius:50%;font-weight:bold}

/* missions */
#missions{
  margin-top:10px;
  background:#eee;
  padding:8px;
  border-radius:8px;
  font-size:13px;
}
.mission{display:flex;justify-content:space-between}
.done{color:green;font-weight:bold}

/* overlay */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
.box{
  background:white;
  padding:20px;
  border-radius:8px;
  text-align:center;
}
.new{color:red;font-weight:bold}
</style>
</head>

<body>
<div id="game">
  <div class="header">
    <div class="scorebox">Score<br><span id="score">0</span></div>
    <div class="scorebox">Best<br><span id="best">0</span></div>
  </div>

  <div id="board"></div>

  <div class="reset-area">
    <button id="r2048"></button>
    <button id="r4096"></button>
    <button id="r8192"></button>
    <button class="info" onclick="openInfo()">i</button>
  </div>

  <div id="missions">
    <div class="mission">Mission 1: 25000点 <span id="m1">✗</span></div>
    <div class="mission">Mission 2: 50000点 <span id="m2">✗</span></div>
    <div class="mission">Mission 3: 100000点 <span id="m3">✗</span></div>
    <div class="mission">Mission 4: 750点以下でGAME OVER <span id="m4">✗</span></div>
  </div>
</div>

<div id="gameover" class="overlay">
  <div class="box">
    <h2>GAME OVER</h2>
    <p>Final Score: <span id="finalScore"></span></p>
    <p>Best Score: <span id="finalBest"></span></p>
    <p id="newRecord" class="new" style="display:none;">NEW RECORD!</p>
    <button onclick="init()">Restart</button>
  </div>
</div>

<div id="info" class="overlay" onclick="this.style.display='none'">
  <div class="box">
    最高スコアが一定値に到達すると<br>
    2048 / 4096 / 8192 がある状態から<br>
    ゲームを開始できます
  </div>
</div>

<script>
const SIZE=4;
let board,merged,spawned=null;
let score=0;
let best=Number(localStorage.getItem("best")||0);
let bestAtStart=best;

const unlock={2048:25000,4096:50000,8192:100000};
const missions=[25000,50000,100000];
let mission4Done=localStorage.getItem("m4")==="1";

function init(){
  merged=[...Array(SIZE)].map(()=>Array(SIZE).fill(false));
  document.getElementById("gameover").style.display="none";
  bestAtStart=best;

  if(!loadGame()){
    board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
    score=0;
    spawn(); spawn();
  }
  update(); draw();
}

function spawn(){
  let e=[];
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++)
    if(!board[i][j]) e.push([i,j]);
  if(!e.length) return;
  const [r,c]=e[Math.random()*e.length|0];
  board[r][c]=Math.random()<0.9?2:4;
  spawned=[r,c];
}

function slide(row,r){
  row=row.filter(v=>v);
  for(let i=0;i<row.length-1;i++){
    if(row[i]===row[i+1]){
      row[i]*=2; score+=row[i];
      row[i+1]=0; merged[r][i]=true;
    }
  }
  row=row.filter(v=>v);
  while(row.length<SIZE) row.push(0);
  return row;
}

function move(dir){
  merged=[...Array(SIZE)].map(()=>Array(SIZE).fill(false));
  let moved=false;
  for(let i=0;i<SIZE;i++){
    let r =
      dir==="L"?board[i]:
      dir==="R"?[...board[i]].reverse():
      dir==="U"?board.map(v=>v[i]):
                board.map(v=>v[i]).reverse();
    let s=slide(r,i);
    let f=(dir==="R"||dir==="D")?s.reverse():s;
    for(let j=0;j<SIZE;j++){
      let v=(dir==="L"||dir==="R")?board[i][j]:board[j][i];
      let nv=f[j];
      if(v!==nv) moved=true;
      if(dir==="L"||dir==="R") board[i][j]=nv;
      else board[j][i]=nv;
    }
  }
  if(moved){
    spawn(); update(); draw(); saveGame();
    if(!canMove()) endGame();
  }
}

function canMove(){
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    if(!board[i][j]) return true;
    if(j<SIZE-1 && board[i][j]===board[i][j+1]) return true;
    if(i<SIZE-1 && board[i][j]===board[i+1][j]) return true;
  }
  return false;
}

function endGame(){
  localStorage.removeItem("board");
  localStorage.removeItem("score");

  document.getElementById("finalScore").textContent=score;
  document.getElementById("finalBest").textContent=best;

  if(score>bestAtStart)
    document.getElementById("newRecord").style.display="block";
  else
    document.getElementById("newRecord").style.display="none";

  if(score<=750){
    mission4Done=true;
    localStorage.setItem("m4","1");
  }

  document.getElementById("gameover").style.display="flex";
}

function update(){
  if(score>best){
    best=score;
    localStorage.setItem("best",best);
  }
  document.getElementById("score").textContent=score;
  document.getElementById("best").textContent=best;
  updateResetButtons();
  updateMissions();
}

function updateMissions(){
  missions.forEach((m,i)=>{
    const e=document.getElementById("m"+(i+1));
    if(best>=m){ e.textContent="✔"; e.className="done"; }
  });
  if(mission4Done){
    document.getElementById("m4").textContent="✔";
    document.getElementById("m4").className="done";
  }
}

function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    const v=board[i][j];
    const d=document.createElement("div");
    d.className="cell"+(v?" n"+v:"");
    if(v) d.textContent=v;
    if(merged[i][j]) d.classList.add("merge");
    if(spawned && spawned[0]===i && spawned[1]===j)
      d.classList.add("spawn");
    b.appendChild(d);
  }
  spawned=null;
}

function updateResetButtons(){
  [2048,4096,8192].forEach(v=>{
    const b=document.getElementById("r"+v);
    if(best>=unlock[v]){
      b.textContent=v;
      b.className="n"+v;
      b.onclick=()=>specialReset(v);
    }else{
      b.textContent=`${unlock[v]}点`;
      b.className="locked";
      b.onclick=()=>alert(`スコア${unlock[v]}到達で解放`);
    }
  });
}

function specialReset(v){
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  board[1][0]=v;
  saveGame(); draw();
}

function saveGame(){
  localStorage.setItem("board",JSON.stringify(board));
  localStorage.setItem("score",score);
}
function loadGame(){
  const b=localStorage.getItem("board");
  const s=localStorage.getItem("score");
  if(b&&s){ board=JSON.parse(b); score=+s; return true; }
  return false;
}
function openInfo(){
  document.getElementById("info").style.display="flex";
}

/* swipe */
let sx=0,sy=0;
document.addEventListener("touchstart",e=>{
  sx=e.touches[0].clientX;
  sy=e.touches[0].clientY;
});
document.addEventListener("touchend",e=>{
  const dx=e.changedTouches[0].clientX-sx;
  const dy=e.changedTouches[0].clientY-sy;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>30) move("R");
    else if(dx<-30) move("L");
  }else{
    if(dy>30) move("D");
    else if(dy<-30) move("U");
  }
});

init();
</script>
</body>
</html>
