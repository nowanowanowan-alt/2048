<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2048 Custom</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  touch-action: none;
  font-family: sans-serif;
  background: #faf8ef;
}

.container {
  max-width: 360px;
  margin: auto;
  text-align: center;
}

h1 { margin: 10px 0; }

.scoreboard {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.board {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  background: #bbada0;
  padding: 8px;
  border-radius: 8px;
}

.cell {
  width: 70px;
  height: 70px;
  background: #cdc1b4;
  border-radius: 6px;
  font-size: 24px;
  font-weight: bold;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: transform 0.15s ease, background 0.15s ease;
}

@keyframes pop {
  from { transform: scale(0); }
  to { transform: scale(1); }
}
.spawn { animation: pop 0.15s ease-out; }

/* タイル色 */
.n2 { background:#fff; }
.n4 { background:#f5d7b5; }
.n8 { background:#f2b179; }
.n16 { background:#f59563; }
.n32 { background:#f67c5f; }
.n64 { background:#f65e3b; }
.n128,.n256,.n512,.n1024,.n2048 { background:#edc22e; }
.n4096 { background:#000; color:#fff; }
.n8192 { background:#6a0dad; color:#fff; }
.n16384 { background:#ff69b4; }

.controls button {
  padding: 8px 14px;
  margin: 2px;
}

#special-buttons {
  margin-top: 8px;
  display: flex;
  gap: 6px;
  justify-content: center;
}
#special-buttons button {
  font-size: 12px;
  padding: 6px 8px;
  border-radius: 6px;
  border: none;
}
.locked {
  background:#ccc;
  color:#666;
}

/* GAME OVER */
#gameover {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
}
.overbox {
  background: #faf8ef;
  padding: 20px 30px;
  border-radius: 10px;
  text-align: center;
  animation: fadein 0.3s ease;
}
@keyframes fadein {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* NEW RECORD */
#record {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #ffcc00;
  padding: 6px 14px;
  border-radius: 20px;
  font-weight: bold;
  display: none;
  z-index: 200;
}
</style>
</head>

<body>
<div id="record">NEW RECORD!</div>

<div class="container">
  <h1>2048</h1>

  <div class="scoreboard">
    <div>Score: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>

  <div id="board" class="board"></div>

  <div class="controls">
    <button onclick="move('up')">↑</button><br>
    <button onclick="move('left')">←</button>
    <button onclick="move('down')">↓</button>
    <button onclick="move('right')">→</button>
  </div>

  <div id="special-buttons">
    <button data-value="2048" onclick="specialReset(2048)">2048 Reset</button>
    <button data-value="4096" onclick="specialReset(4096)">4096 Reset</button>
    <button data-value="8192" onclick="specialReset(8192)">8192 Reset</button>
  </div>
</div>

<div id="gameover">
  <div class="overbox">
    <h2>GAME OVER</h2>
    <p>Final Score: <span id="finalScore">0</span></p>
    <p>Best Score: <span id="finalBest">0</span></p>
    <button onclick="init()">Restart</button>
  </div>
</div>

<script>
const SIZE = 4;
let board = [];
let score = 0;
let best = Number(localStorage.getItem("best2048")) || 0;

const resetConditions = {2048:25000,4096:50000,8192:100000};
const tileColors = {2048:"#edc22e",4096:"#000",8192:"#6a0dad"};

function init() {
  document.getElementById("gameover").style.display = "none";
  document.getElementById("record").style.display = "none";
  board = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
  score = 0;
  addTile(); addTile();
  draw();
}

function addTile() {
  const empty=[];
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++)if(!board[i][j])empty.push([i,j]);
  if(!empty.length) return;
  const [r,c]=empty[Math.floor(Math.random()*empty.length)];
  board[r][c]=Math.random()<0.9?2:4;
}

function slide(row){
  row=row.filter(v=>v);
  for(let i=0;i<row.length-1;i++){
    if(row[i]===row[i+1]){
      row[i]*=2;
      score+=row[i];
      row[i+1]=0;
    }
  }
  row=row.filter(v=>v);
  while(row.length<SIZE)row.push(0);
  return row;
}

function rotate(){
  board=board[0].map((_,i)=>board.map(r=>r[i]).reverse());
}

function move(dir){
  let moved=false;
  if(dir==="up")rotate();
  if(dir==="right"){rotate();rotate();}
  if(dir==="down"){rotate();rotate();rotate();}

  for(let i=0;i<SIZE;i++){
    const old=[...board[i]];
    board[i]=slide(board[i]);
    if(old.join()!=board[i].join())moved=true;
  }

  if(dir==="up"){rotate();rotate();rotate();}
  if(dir==="right"){rotate();rotate();}
  if(dir==="down")rotate();

  if(moved){
    addTile();
    if(score>best){
      best=score;
      localStorage.setItem("best2048",best);
      showRecord();
    }
    draw();
    if(!canMove())showGameOver();
  }
}

function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    const v=board[i][j];
    const d=document.createElement("div");
    d.className="cell"+(v?" n"+v:"");
    if(v)d.classList.add("spawn");
    d.textContent=v||"";
    b.appendChild(d);
  }
  document.getElementById("score").textContent=score;
  document.getElementById("best").textContent=best;
  updateSpecialButtons();
}

function canMove(){
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    if(board[i][j]===0) return true;
    if(j<SIZE-1 && board[i][j]===board[i][j+1]) return true;
    if(i<SIZE-1 && board[i][j]===board[i+1][j]) return true;
  }
  return false;
}

function showGameOver(){
  document.getElementById("finalScore").textContent=score;
  document.getElementById("finalBest").textContent=best;
  document.getElementById("gameover").style.display="flex";
}

function showRecord(){
  const r=document.getElementById("record");
  r.style.display="block";
  setTimeout(()=>r.style.display="none",1500);
}

function updateSpecialButtons(){
  document.querySelectorAll("#special-buttons button").forEach(btn=>{
    const v=btn.dataset.value;
    if(best>=resetConditions[v]){
      btn.className="";
      btn.style.background=tileColors[v];
    }else{
      btn.className="locked";
      btn.style.background="#ccc";
    }
  });
}

function specialReset(v){
  if(best<resetConditions[v]){
    alert(`スコア${resetConditions[v]}到達で解放`);
    return;
  }
  board.forEach(r=>r.fill(0));
  board[Math.floor(SIZE/2)][0]=v;
  draw();
}

/* スワイプ */
let sx,sy;
document.addEventListener("touchstart",e=>{
  sx=e.touches[0].clientX;
  sy=e.touches[0].clientY;
});
document.addEventListener("touchend",e=>{
  const dx=e.changedTouches[0].clientX-sx;
  const dy=e.changedTouches[0].clientY-sy;
  if(Math.abs(dx)>Math.abs(dy)){
    dx>0?move("right"):move("left");
  }else{
    dy>0?move("down"):move("up");
  }
});
document.addEventListener("touchmove",e=>e.preventDefault(),{passive:false});

init();
</script>
</body>
</html>
