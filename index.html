<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2048 Custom</title>

<style>
*{
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
}

body{
  margin:0;
  background:#faf8ef;
  font-family:sans-serif;
  text-align:center;
}

  body{
  overscroll-behavior: none;
}

h1{margin:10px 0}

#top{
  display:flex;
  justify-content:space-around;
  font-size:18px;
}

#board{
  width:300px;
  margin:15px auto;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
  background:#bbada0;
  padding:6px;
  border-radius:8px;
}
  
#board{
  touch-action: none;
}

.cell{
  width:70px;
  height:70px;
  background:#cdc1b4;
  border-radius:6px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  font-size:22px;
  transition:transform .12s ease;
}

/* animations */
@keyframes spawn{0%{transform:scale(.6)}100%{transform:scale(1)}}
@keyframes merge{0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)}}
.spawn{animation:spawn .15s ease}
.merge{animation:merge .18s ease}

/* colors */
.n2{background:#eee4da}
.n4{background:#f0d9c2}
.n8{background:#f2b179}
.n16{background:#f59563}
.n32{background:#f67c5f}
.n64{background:#f65e3b;color:#fff}
.n128,.n256,.n512,.n1024,.n2048{background:#edcf72}
.n4096{background:#000;color:#fff}
.n8192{background:purple;color:#fff}
.n16384{background:pink}
.n32768{background:#fff}

button{
  margin:4px;
  padding:6px 10px;
  font-size:14px;
}

#missionBtn{
  margin-top: 12px;
  padding: 10px 16px;
  font-size: 16px;
}

.modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.modalContent{
  background: #fff;
  color: #000;
  padding: 20px;
  border-radius: 12px;
  width: 80%;
  max-width: 320px;
}

.hidden{
  display: none;
}

.locked{
  background:#aaa;
  color:#555;
}

/* Game Over overlay */
#gameover{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  color:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:22px;

  opacity:0;
  pointer-events:none;
  transition:.2s;
}
#gameover.show{
  opacity:1;
  pointer-events:auto;
}
</style>
</head>

<body>
<h1>2048</h1>

<div id="top">
  <div>Score: <span id="score">0</span></div>
  <div>Best: <span id="best">0</span></div>
</div>

<div id="board"></div>

<div>
  <button onclick="move('U')">‚Üë</button><br>
  <button onclick="move('L')">‚Üê</button>
  <button onclick="move('D')">‚Üì</button>
  <button onclick="move('R')">‚Üí</button><br><br>

  <button onclick="fullReset()">RESET</button><br><br>

  <button id="r2048" onclick="specialReset(2048,20000,1)">2048</button>
  <button id="r4096" onclick="specialReset(4096,40000,2)">4096</button>
  <button id="r8192" onclick="specialReset(8192,80000,3)">8192</button>
  <button onclick="info()">i</button>
</div>

<button id="missionBtn">üìú „Éü„ÉÉ„Ç∑„Éß„É≥</button>

<div id="missionModal" class="modal hidden">
  <div class="modalContent">
    <h2>„Éü„ÉÉ„Ç∑„Éß„É≥</h2>
    <ul id="missionList"></ul>
    <button id="closeMission">Èñâ„Åò„Çã</button>
  </div>
</div>
  
<div id="gameover">
  <div>GAME OVER</div>
  <div id="finalScore"></div>
  <div id="newRecord"></div>
  <button onclick="restart()">Restart</button>
</div>

<script>
const SIZE=4;
let board=[],score=0;
let best=Number(localStorage.getItem("best"))||0;
document.getElementById("best").textContent=best;

/* ---------- save / load ---------- */
function saveGame(){
  localStorage.setItem("board",JSON.stringify(board));
  localStorage.setItem("score",score);
}
function loadGame(){
  let b=localStorage.getItem("board");
  let s=localStorage.getItem("score");
  if(b && s){
    board=JSON.parse(b);
    score=Number(s);
    return true;
  }
  return false;
}
function clearSave(){
  localStorage.removeItem("board");
  localStorage.removeItem("score");
}

/* ---------- init ---------- */
function init(){
  document.getElementById("gameover").classList.remove("show");

  if(!loadGame()){
    board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
    score=0;
    spawn();spawn();
  }
  update();draw();
}
  
/* ---------- game logic ---------- */
function spawn(){
  let e=[];
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++)
    if(!board[i][j]) e.push([i,j]);
  if(!e.length) return;
  let [r,c]=e[Math.random()*e.length|0];
  board[r][c]=Math.random()<0.9?2:4;
}

function slide(arr){
  arr=arr.filter(v=>v);
  for(let i=0;i<arr.length-1;i++){
    if(arr[i]===arr[i+1]){
      arr[i]*=2;
      score+=arr[i];
      arr.splice(i+1,1);
    }
  }
  while(arr.length<SIZE) arr.push(0);
  return arr;
}

function move(dir){
  let moved=false;

  for(let i=0;i<SIZE;i++){
    if(dir==="L"){
      let r=slide(board[i]);
      if(board[i].join()!=r.join()) moved=true;
      board[i]=r;
    }
    if(dir==="R"){
      let r=slide([...board[i]].reverse()).reverse();
      if(board[i].join()!=r.join()) moved=true;
      board[i]=r;
    }
    if(dir==="U"){
      let col=slide(board.map(v=>v[i]));
      for(let j=0;j<SIZE;j++){
        if(board[j][i]!==col[j]) moved=true;
        board[j][i]=col[j];
      }
    }
    if(dir==="D"){
      let col=slide(board.map(v=>v[i]).reverse()).reverse();
      for(let j=0;j<SIZE;j++){
        if(board[j][i]!==col[j]) moved=true;
        board[j][i]=col[j];
      }
    }
  }

  if(moved){
    spawn();
    update();
    draw();
    saveGame();
    if(!canMove()) endGame();
  }
}

function canMove(){
  for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE;j++){
    if(!board[i][j]) return true;
    if(board[i][j]===board[i]?.[j+1]) return true;
    if(board[i][j]===board[i+1]?.[j]) return true;
  }
  return false;
}

let isTouchingBoard = false;

const board = document.getElementById("board");

board.addEventListener("touchstart", e => {
  e.preventDefault();
  isTouchingBoard = true;

  const t = e.touches[0];
  startX = t.clientX;
  startY = t.clientY;
}, { passive: false });

board.addEventListener("touchmove", e => {
  if (!isTouchingBoard) return;
  e.preventDefault();
}, { passive: false });

board.addEventListener("touchend", e => {
  if (!isTouchingBoard) return;

  const t = e.changedTouches[0];
  const dx = t.clientX - startX;
  const dy = t.clientY - startY;

  handleSwipe(dx, dy);
  isTouchingBoard = false;
});

document.body.addEventListener("touchstart", () => {
  isTouchingBoard = false;
});

  const missionBtn = document.getElementById("missionBtn");
const missionModal = document.getElementById("missionModal");
const closeMission = document.getElementById("closeMission");
const missionList = document.getElementById("missionList");

missionBtn.onclick = () => {
  updateMissionList();
  missionModal.classList.remove("hidden");
};

closeMission.onclick = () => {
  missionModal.classList.add("hidden");
};

function updateMissionList(){
  missionList.innerHTML = `
    <li>${missions.m1 ? "‚úÖ" : "‚¨ú"} „Éü„ÉÉ„Ç∑„Éß„É≥1Ôºö25000ÁÇπÂà∞ÈÅî</li>
    <li>${missions.m2 ? "‚úÖ" : "‚¨ú"} „Éü„ÉÉ„Ç∑„Éß„É≥2Ôºö50000ÁÇπÂà∞ÈÅî</li>
    <li>${missions.m3 ? "‚úÖ" : "‚¨ú"} „Éü„ÉÉ„Ç∑„Éß„É≥3Ôºö100000ÁÇπÂà∞ÈÅî</li>
    <li>${missions.m4 ? "‚úÖ" : "‚¨ú"} „Éü„ÉÉ„Ç∑„Éß„É≥4Ôºö750ÁÇπ‰ª•‰∏ã„ÅßGame Over</li>
  `;
}
  
/* ---------- UI ---------- */
function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let r of board)for(let v of r){
    let d=document.createElement("div");
    d.className="cell"+(v?" n"+v:"");
    d.textContent=v||"";
    b.appendChild(d);
  }
}

function update(){
  document.getElementById("score").textContent=score;
  if(score>best){
    best=score;
    localStorage.setItem("best",best);
    document.getElementById("best").textContent=best;
  }
  updateLocks();
}

function updateLocks(){
  lock("r2048",best<25000);
  lock("r4096",best<50000);
  lock("r8192",best<100000);
}
function lock(id,state){
  document.getElementById(id).classList.toggle("locked",state);
}

/* ---------- resets ---------- */
function specialReset(v,s,m){
  if((m==1&&best<25000)||(m==2&&best<50000)||(m==3&&best<100000)){
    alert("„Éü„ÉÉ„Ç∑„Éß„É≥"+m+"„Çí„ÇØ„É™„Ç¢„Åô„Çã„Å®Ëß£Êîæ");
    return;
  }
  score=s;
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  board[0][0]=v;
  saveGame();
  update();draw();
}

function fullReset(){
  clearSave();
  board=[...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  score=0;
  spawn();spawn();
  update();draw();
}

function restart(){
  clearSave();

  const over = document.getElementById("gameover");
  over.classList.remove("show");

  board = [...Array(SIZE)].map(()=>Array(SIZE).fill(0));
  score = 0;
  spawn();
  spawn();
  update();
  draw();
}

/* ---------- game over ---------- */
function endGame(){
  clearSave();
  document.getElementById("finalScore").textContent="Score: "+score;
  document.getElementById("newRecord").textContent=score===best?"New Record!":"";
  document.getElementById("gameover").classList.add("show");
}

function info(){
  alert("ÊúÄÈ´ò„Çπ„Ç≥„Ç¢„Åå‰∏ÄÂÆöÂÄ§„Å´Âà∞ÈÅî„Åô„Çã„Å®„ÄÅÁâπÂÆö„Çø„Ç§„É´„Åã„Çâ„Ç≤„Éº„É†„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô");
}

init();

  let startX = 0, startY = 0;

document.addEventListener("touchstart", e => {
  if (e.touches.length !== 1) return;
  startX = e.touches[0].clientX;
  startY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener("touchend", e => {
  if (!startX || !startY) return;

  const dx = e.changedTouches[0].clientX - startX;
  const dy = e.changedTouches[0].clientY - startY;

  if (Math.abs(dx) > Math.abs(dy)) {
    if (dx > 30) move("R");
    else if (dx < -30) move("L");
  } else {
    if (dy > 30) move("D");
    else if (dy < -30) move("U");
  }

  startX = startY = 0;
});

  const boardElem = document.getElementById("board");

boardElem.addEventListener("touchstart", e => {
  e.preventDefault();
}, { passive: false });

boardElem.addEventListener("touchmove", e => {
  e.preventDefault();
}, { passive: false });
  
</script>
</body>
</html>
